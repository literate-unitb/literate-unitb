\documentclass{article}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{bsymb}
\usepackage{unitb}
% \usepackage{eventb}
\usepackage{calculation}

\begin{document}
	
\begin{machine}{m0}
	
\[
\variable{ b : \Bool }
\]

\newevent{term}{terminate}

\begin{align}
\initialization{in0}{b = \false} \\
\progress{prog0}{\true}{b}
\end{align}

\begin{align}
\refine{prog0}{ensure}{term}{} \\
\weakento{term}{default}{sch0} \\
\cschedule{term}{sch0}{\true} 
\end{align}

\begin{align}
\evbcmeq{term}{act0}{b}{\true}
\end{align}


\end{machine}

\newcommand{\Pcs}{\text{P}}

\begin{machine}{m1}
	\refines{m0}

\with{sets}
\begin{align*}	
\newset{P}{\Pcs} \\
\variable{ vs : \set[\Pcs] } \\
\dummy{V : \set[\Pcs]}
\end{align*}

\begin{align}
	\invariant{inv0}{b \2\implies& vs = \Pcs} \\
	\evguard{term}{grd0}{ vs &= \Pcs } \\
	\cschedule{term}{sch1}{ vs &= \Pcs }
\end{align}

\replace{term}{sch0}{sch1}{}{prog1}{saf1}

\begin{align*}
	\safety{saf1}{vs = \Pcs}{\false}
\end{align*}
	
\begin{align*}
	&\progress{prog1}{\true}{vs = \Pcs} 
\refine{prog1}{induction}{prog2}
		{ \var{\Pcs \setminus vs}{down}{\emptyset} }
	&\progress{prog2}
		{ \Pcs \setminus vs = V }
		{ (\Pcs \setminus vs \subset V) \1\lor vs = \Pcs }
\refine{prog2}{psp}{prog3,saf2}{}
	&\progress{prog3}
		{ \Pcs \setminus vs = V \land \neg vs = \Pcs}
		{\neg \Pcs \setminus vs = V} \\
	&\safety{saf2}{\Pcs \setminus vs \subseteq V}{vs = \Pcs}
\refine{prog3}{ensure}{visit}{ [\witness{p}{\neg p' \in vs}] }
\end{align*}

\newevent{visit}{visit}

\[ \indices{visit}{p : \Pcs} \]

\begin{align}
% 	\cschedule{visit}{sch0}{}
	\evbcmeq{visit}{act1}{vs}{ vs \bunion \{ p \} }
\end{align}

\weakento{visit}{default}{}

\input{m1_visit}

\end{machine}

\end{document}
